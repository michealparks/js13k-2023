import"https://cdn.jsdelivr.net/gh/aframevr/aframe@ef03254934395d6a0a3cd093a8d37bb90790d24e/dist/aframe-master.min.js";const e=e=>e.target.object3D,t=e=>e.el,a=e=>e.data,r=(e,a,r)=>t(e).addEventListener(a,r),o=(e,t)=>AFRAME.registerComponent(e,{...t,init(){this.system?.register(this.el),t.init?.call(this)},remove(){this.system?.deregister(this.el)}});let n=[];o("frame",{tick(e,t){for(let a of n)a(e,t)}});let i=e=>new THREE.MeshStandardMaterial(e),s=(...e)=>new THREE.InstancedMesh(...e),l=(...e)=>new THREE.Mesh(...e),d=(e=0,t=0,a)=>l(new THREE.PlaneGeometry(e,t),i(a)),c=(e,t)=>e.getObjectByName(t),h=THREE;o("raycasted",{init(){let e=a(this);e.lastPoint=new h.Vector3(-9999),r(this,"raycaster-intersected",(t=>e.raycaster=t.detail.el)),r(this,"raycaster-intersected-cleared",(()=>e.raycaster=void 0))},tick(){let e=a(this),{lastPoint:r}=e,o=t(this),n=e.raycaster?.components.raycaster.getIntersection(o);if(!n)return;let{point:i}=n;i.x===r.x&&i.y===r.y&&i.z===r.z||(o.emit("intersection",n),e.lastPoint=i)}});let m="#7BD5F5",p="tan",{random:f}=Math,g=new h.Matrix4,u=new h.Vector3;new h.Quaternion,new h.Vector3;let y=new h.Object3D,b=e=>new THREE.CatmullRomCurve3(e),x=(e,t,a)=>e.push(u.set(t,0,a).clone()),w=e=>{let t=[],a=.4*e,r=0;x(t,a,r),a+=.5*e,x(t,a,r);for(let l=0;l<10;l++)a+=Math.random()*e,r=2*(Math.random()-.5),x(t,a,r);let o=b(t),n=b(o.getPoints(100)),i=new THREE.TubeGeometry(n,100,.02,6,!1),s=new THREE.MeshStandardMaterial({color:"#B0BEC5",roughness:1});return{smoothPath:n,mesh:l(i,s)}},E=[w(-1),w(1)];const v=(e=.1,t=.1,a=.1,r=0,o=0,n=0,l)=>s(new h.BoxGeometry(e,t,a).translate(r,o,n),i({color:l}),1e3);let M=(e,t,a)=>{let r=document.createElement(e);for(let o in t)T(r,o,t[o]);for(let o in a)R(r,o,a[o]);return r},T=(e,t,a)=>e.setAttribute(t,a),R=(e,t,a)=>e.addEventListener(t,a),H=e=>document.querySelector(e),P=e=>e.getBoundingClientRect(),S=e=>{let t=[];return{current:e,set(e){this.current=e;for(let a of t)a(e)},subscribe(e){t.push(e),e(this.current)}}},A=S(localStorage.getItem("state")??"screen");S(new THREE.Vector3);let C=d(.4,.4,{color:"#fff"});C.position.set(0,1,0),C.rotation.x=-Math.PI/4;let L=M("div");document.body.append(L),L.className="absolute -top-full -left-full px-24 py-24",A.subscribe((e=>{if(C.visible=!1,C.clear(),"intro"===e)L.innerHTML="\n<div class='h-[900px] w-[1100px] text-5xl'>\n  <p class='text-6xl'>Hail, my Liege.\n  <p class='mt-0 mb-16'>Thou art The King - if perchance you forgot again today.\n  <p>I must apprise thee that your chosen people are envied\n  <p class='mt-0 mb-16'>for being, well, chosen.\n  <p>Please muster thy utmost valor to defend them,\n  <p class='mt-0 mb-16'>they're all really good chaps once you get past the smell.\n  <p>Sincerely, thy most humble and abasing subject,\n  <p>Humphrey Bumblebuns, XO\n</div>";else{if("tutorial"!==e)return;L.innerHTML="\n<div class='h-[900px] w-[1100px] text-5xl'>\n  <p>Pull the trigger on thy divine scepter to fire lasers. Hallowed by thy aim.\n  <p>Lobby thy royal orb at foes, and they shall surely bend the knee before the might of thy five megaton explosions.\n</div>\n"}let t=(e=>{let t=document.createRange(),a=P(e),r=M("canvas");r.width=a.width,r.height=a.height;let o=r.getContext("2d"),n=(e,r)=>{if(e.nodeType===Node.TEXT_NODE){t.selectNode(e);let n=P(t);((e,t,a,r)=>{o.font=`${e.fontWeight} ${e.fontSize} ${e.fontFamily}`,o.textBaseline="top",o.fillStyle=e.color,o.fillText(r,t,a+.1*(0|e.fontSize))})(r,n.left-a.left-.5,n.top-a.top-.5,e.nodeValue.trim())}else r=window.getComputedStyle(e);for(let t of e.childNodes)n(t,r)};return n(e,{}),r})(L),a=new h.CanvasTexture(t);a.anisotropy=4;let r=d(.4,.4,{map:a,transparent:!0});r.position.z=.001,C.add(r),C.visible=!0}));let j,B=M("a-scene",{frame:"",reflection:"",fog:`far:5;color:${m}`,shadow:"type:pcfsoft",renderer:"antialias:true;colorManagement:true;highRefreshRate:true;physicallyCorrectLights:true;toneMapping:ACESFilmic"},{loaded(e){j=e.target.renderer,j.xr.setFoveation(1),(e=>{let t=s(new THREE.ConeGeometry(.15,.5,4,1,!0),i({color:"#388E3C"}),1e3);for(let a=0;a<1e3;a++){let[e,r]=(e=>{let t=2*Math.PI*f();return[e*Math.cos(t),e*Math.sin(t)]})(2*Math.sqrt(f())+2),o=f()+.3;t.setMatrixAt(a,g.makeTranslation(u.set(e,.25*o,r)).scale(u.set(f()+.3,o,f()+.3)))}e.add(t)})(z),(e=>{let t=.01,a=.005,r=.0175,o=[v(t,t,t,0,.04,0,p),v(.02,.03,.004,0,.02,0,"brown"),v(a,r,a,-.012,.025,0,p),v(a,r,a,.012,.025,0,p)],i=new Float32Array(2e3);for(let n=0;n<2e3;n+=2)i[n+1]=.25+.02*n;var s;e.add(...o),s=e=>{let t=e/7e4;for(let a=0,r=0;a<1e3;a++,r+=2){let r=a/200;E[a%2].smoothPath.getPointAt(1-(t+r)%1,y.position),E[a%2].smoothPath.getPointAt(1-(t+r+.01)%1,u),y.position.y=Math.sin(e/50)/300+.015,y.lookAt(u.x,.03,u.z),y.updateMatrix();for(let e of o)e.setMatrixAt(a,y.matrix)}for(let a of o)a.instanceMatrix.needsUpdate=!0},n.push(s)})(z),(e=>{e.add(C)})(z),(e=>{e.add(E[0].mesh,E[1].mesh)})(z),(e=>{let t=new THREE.DirectionalLight("#fff",2);e.add(t),t.position.set(1,2,1),t.target;let{shadow:a}=t;a.bias=1e-5,a.mapSize.set(2048,2048),a.normalBias=.02;let{camera:r}=a;r.left=r.bottom=-5,r.right=r.top=5})(z)},"enter-vr"(){j.xr.getSession()?.updateTargetFrameRate(120)?.catch((()=>{})),T(F,"visible",!0),T(k,"visible",!0),A.set("intro")}}),z=B.object3D,D="objects:.collidable;lineOpacity:1;autoRefresh:false",k=M("a-entity",{id:"hand_left",visible:!1,"laser-controls":"hand:left;model:false",raycaster:D},{triggerdown(){},triggerup(){}}),F=M("a-entity",{id:"hand_right",visible:!1,"laser-controls":"hand:right;model:false",raycaster:D},{triggerdown(){},triggerup(){}});B.append(F,k),B.append(M("a-sky",{color:m})),B.append(M("a-light",{type:"ambient",color:"#445451"})),B.append(M("a-camera",{position:"0 0.5 1.8","look-controls-enabled":!1})),B.append(M("a-cylinder",{radius:30,height:.01,color:"#18A558",class:"collidable",raycasted:""},{intersection(e){}})),B.append(M("a-gltf-model",{src:"castle-prod.glb"},{"model-loaded"(t){let a=c(e(t),"scepter"),r=c(e(t),"orb");H("#hand_right").object3D.add(a),H("#hand_left").object3D.add(r),z.traverse((e=>{const t=e;t.castShadow=t.isMesh||t.isLight&&!t.isAmbientLight&&!t.isRectAreaLight,t.receiveShadow=t.isMesh}))}}));let I=M("h1",{class:"z-10 fixed text-white text-9xl text-center w-full"});I.innerHTML="<q>Keep Calm</q>";let N=M("h2",{class:"z-10 m-0 fixed bottom-5 right-24 text-3xl text-white"});N.innerHTML="xr"in navigator?"Begin thy reign â†’":"Thy majesty must procure a magical VR crown",document.body.append(I,N,B);
