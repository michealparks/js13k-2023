import"https://cdn.jsdelivr.net/gh/aframevr/aframe@ef03254934395d6a0a3cd093a8d37bb90790d24e/dist/aframe-master.min.js";const e=e=>e.target.object3D,t=e=>e.el,a=e=>e.data,n=(e,a,n)=>t(e).addEventListener(a,n),o=(e,t)=>AFRAME.registerComponent(e,{...t,init(){this.system?.register(this.el),t.init?.call(this)},remove(){this.system?.deregister(this.el)}});let r=[];o("frame",{tick(e,t){for(let a of r)a(e,t)}});let i=e=>new THREE.MeshStandardMaterial(e),l=(...e)=>new THREE.InstancedMesh(...e),s=(...e)=>new THREE.Mesh(...e),d=(e=0,t=0,a)=>s(new THREE.PlaneGeometry(e,t),i(a)),c=(e,t)=>e.getObjectByName(t),h=THREE;o("raycasted",{init(){let e=a(this);e.lastPoint=new h.Vector3(-9999),n(this,"raycaster-intersected",(t=>e.raycaster=t.detail.el)),n(this,"raycaster-intersected-cleared",(()=>e.raycaster=void 0))},tick(){let e=a(this),{lastPoint:n}=e,o=t(this),r=e.raycaster?.components.raycaster.getIntersection(o);if(!r)return;let{point:i}=r;i.x===n.x&&i.y===n.y&&i.z===n.z||(o.emit("intersection",r),e.lastPoint=i)}});let p="#7BD5F5",m="tan",{random:f}=Math,g=new h.Matrix4,u=new h.Vector3;new h.Quaternion,new h.Vector3;let y=new h.Object3D,b=e=>new THREE.CatmullRomCurve3(e),x=(e,t,a)=>e.push(u.set(t,0,a).clone()),w=e=>{let t=[],a=.4*e,n=0;x(t,a,n),a+=.5*e,x(t,a,n);for(let s=0;s<10;s++)a+=Math.random()*e,n=2*(Math.random()-.5),x(t,a,n);let o=b(t),r=b(o.getPoints(100)),i=new THREE.TubeGeometry(r,100,.02,6,!1),l=new THREE.MeshStandardMaterial({color:"#B0BEC5",roughness:1});return{smoothPath:r,mesh:s(i,l)}},v=[w(-1),w(1)];const E=(e=.1,t=.1,a=.1,n=0,o=0,r=0,s)=>l(new h.BoxGeometry(e,t,a).translate(n,o,r),i({color:s}),1e3);let M=e=>e.getBoundingClientRect(),T=(e,t,a)=>{let n=document.createElement(e);for(let o in t)R(n,o,t[o]);for(let o in a)H(n,o,a[o]);return n},R=(e,t,a)=>e.setAttribute(t,a),H=(e,t,a)=>e.addEventListener(t,a),S=e=>document.querySelector(e);function P(){}const A=[];let C=((e,t=P)=>{let a;const n=new Set;function o(t){if(((e,t)=>e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e)(e,t)&&(e=t,a)){const t=!A.length;for(const a of n)a[1](),A.push(a,e);if(t){for(let e=0;e<A.length;e+=2)A[e][0](A[e+1]);A.length=0}}}function r(t){o(t(e))}return{set:o,update:r,subscribe(i,l=P){const s=[i,l];return n.add(s),1===n.size&&(a=t(o,r)||P),i(e),()=>{n.delete(s),0===n.size&&a&&(a(),a=null)}}}})(localStorage.getItem("state")??"screen"),L=d(.4,.4,{color:"#fff"});L.position.set(0,1,0),L.rotation.x=-Math.PI/4;let j=T("div");document.body.append(j),j.className="absolute -top-full -left-full px-24 py-24",C.subscribe((e=>{if(L.visible=!1,L.clear(),"intro"===e)j.innerHTML="\n<div class='h-[900px] w-[1100px] text-5xl'>\n  <p class='text-6xl'>Hail, my Liege.\n  <p class='mt-0 mb-16'>Thou art The King - if perchance you forgot again today.\n  <p>I must apprise thee that your chosen people are envied\n  <p class='mt-0 mb-16'>for being, well, chosen.\n  <p>Please muster thy utmost valor to defend them,\n  <p class='mt-0 mb-16'>they're all really good chaps once you get past the smell.\n  <p>Sincerely, thy most humble and abasing subject,\n  <p>Humphrey Bumblebuns, XO\n</div>";else{if("tutorial"!==e)return;j.innerHTML="\n<div class='h-[900px] w-[1100px] text-5xl'>\n  <p>Pull the trigger on thy divine scepter to fire lasers. Hallowed by thy aim.\n  <p>Lobby thy royal orb at foes, and they shall surely bend the knee before the might of thy five megaton explosions.\n</div>\n"}let t=(e=>{let t=document.createRange(),a=M(e),n=document.createElement("canvas");n.width=a.width,n.height=a.height;let o=n.getContext("2d"),r=(e,n)=>{if(e.nodeType===Node.TEXT_NODE){t.selectNode(e);let r=M(t);((e,t,a,n)=>{o.font=`${e.fontWeight} ${e.fontSize} ${e.fontFamily}`,o.textBaseline="top",o.fillStyle=e.color,o.fillText(n,t,a+.1*(0|e.fontSize))})(n,r.left-a.left-.5,r.top-a.top-.5,e.nodeValue.trim())}else n=window.getComputedStyle(e);for(let t of e.childNodes)r(t,n)};return r(e,{}),n})(j),a=new h.CanvasTexture(t);a.anisotropy=4;let n=d(.4,.4,{map:a,transparent:!0});n.position.z=.001,L.add(n),L.visible=!0}));let z,B=T("a-scene",{frame:"",reflection:"",fog:`far:5;color:${p}`,shadow:"type:pcfsoft",renderer:"antialias:true;colorManagement:true;highRefreshRate:true;physicallyCorrectLights:true;toneMapping:ACESFilmic"},{loaded(e){z=e.target.renderer,z.xr.setFoveation(1),(e=>{let t=l(new THREE.ConeGeometry(.15,.5,4,1,!0),i({color:"#388E3C"}),1e3);for(let a=0;a<1e3;a++){let[e,n]=(e=>{let t=2*Math.PI*f();return[e*Math.cos(t),e*Math.sin(t)]})(2*Math.sqrt(f())+2),o=f()+.3;t.setMatrixAt(a,g.makeTranslation(u.set(e,.25*o,n)).scale(u.set(f()+.3,o,f()+.3)))}e.add(t)})(D),(e=>{let t=.01,a=.005,n=.0175,o=[E(t,t,t,0,.04,0,m),E(.02,.03,.004,0,.02,0,"brown"),E(a,n,a,-.012,.025,0,m),E(a,n,a,.012,.025,0,m)],i=new Float32Array(2e3);for(let r=0;r<2e3;r+=2)i[r+1]=.25+.02*r;var l;e.add(...o),l=e=>{let t=e/7e4;for(let a=0,n=0;a<1e3;a++,n+=2){let n=a/200;v[a%2].smoothPath.getPointAt(1-(t+n)%1,y.position),v[a%2].smoothPath.getPointAt(1-(t+n+.01)%1,u),y.position.y=Math.sin(e/50)/300+.015,y.lookAt(u.x,.03,u.z),y.updateMatrix();for(let e of o)e.setMatrixAt(a,y.matrix)}for(let a of o)a.instanceMatrix.needsUpdate=!0},r.push(l)})(D),(e=>{e.add(L)})(D),(e=>{e.add(v[0].mesh,v[1].mesh)})(D),(e=>{let t=new THREE.DirectionalLight("#fff",2);e.add(t),t.position.set(1,2,1),t.target;let{shadow:a}=t;a.bias=1e-5,a.mapSize.set(2048,2048),a.normalBias=.02;let{camera:n}=a;n.left=n.bottom=-5,n.right=n.top=5})(D)},"enter-vr"(){z.xr.getSession()?.updateTargetFrameRate(120)?.catch((()=>{})),R(I,"visible",!0),R(F,"visible",!0),C.set("intro")}}),D=B.object3D,k="objects:.collidable;lineOpacity:1;autoRefresh:false",F=T("a-entity",{id:"hand_left",visible:!1,"laser-controls":"hand:left;model:false",raycaster:k},{triggerdown(){},triggerup(){}}),I=T("a-entity",{id:"hand_right",visible:!1,"laser-controls":"hand:right;model:false",raycaster:k},{triggerdown(){},triggerup(){}});B.append(I,F),B.append(T("a-sky",{color:p})),B.append(T("a-light",{type:"ambient",color:"#445451"})),B.append(T("a-camera",{position:"0 0.5 1.8","look-controls-enabled":!1})),B.append(T("a-cylinder",{radius:30,height:.01,color:"#18A558",class:"collidable",raycasted:""},{intersection(e){}})),B.append(T("a-gltf-model",{src:"castle-prod.glb"},{"model-loaded"(t){let a=c(e(t),"scepter"),n=c(e(t),"orb");S("#hand_right").object3D.add(a),S("#hand_left").object3D.add(n),D.traverse((e=>{const t=e;t.castShadow=t.isMesh||t.isLight&&!t.isAmbientLight&&!t.isRectAreaLight,t.receiveShadow=t.isMesh}))}}));let N=T("h1",{class:"z-10 fixed text-white text-9xl text-center w-full"});N.innerHTML="<q>Keep Calm</q>";let O=T("h2",{class:"z-10 m-0 fixed bottom-5 right-24 text-3xl text-white"});O.innerHTML="xr"in navigator?"Begin thy reign â†’":"Thy majesty must procure a magical VR crown",document.body.append(N,O,B);
